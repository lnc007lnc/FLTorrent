# ChunkManageræ¨¡å‹åˆ†å—å­˜å‚¨ç³»ç»Ÿå®ç°æŠ¥å‘Š

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æˆåŠŸå®ç°äº†åŸºäºç”¨æˆ·æä¾›ç®—æ³•çš„æ¨¡å‹åˆ†å—å­˜å‚¨ç³»ç»Ÿï¼Œæ›¿æ¢äº†FederatedScopeä¸­åŸæœ‰çš„ä¼ ç»Ÿæ¨¡å‹ä¿å­˜æœºåˆ¶ã€‚è¯¥ç³»ç»Ÿä½¿ç”¨æ‰å¹³ç´¢å¼•è®°å½•å‚æ•°chunkä¿¡æ¯ï¼Œå¹¶å°†æ¨¡å‹æƒé‡æŒ‰ç…§æŒ‡å®šæ ¼å¼å­˜å‚¨åœ¨æœ¬åœ°æ•°æ®åº“ä¸­ã€‚

## ğŸ”§ æ ¸å¿ƒå®ç°

### 1. ChunkManagerç±» (`federatedscope/core/chunk_manager.py`)

**ä¸»è¦åŠŸèƒ½**ï¼š
- ç»Ÿä¸€ç®¡ç†æ¨¡å‹åˆ†å—é€»è¾‘ï¼Œä½¿ç”¨æ‰å¹³ç´¢å¼•è®°å½•å‚æ•°chunkä¿¡æ¯
- æ¯ä¸ªchunkçš„å®šä¹‰æ ¼å¼ï¼š
  ```python
  {
      'chunk_id': int,
      'parts': { key: [ (flat_start, flat_end, shape), ... ] },
      'flat_size': int
  }
  ```

**æ ¸å¿ƒæ–¹æ³•**ï¼š
- `model_to_params()`: å°†æ¨¡å‹å‚æ•°è½¬æ¢ä¸ºnumpyæ•°ç»„
- `split_model()`: å°†æ¨¡å‹å‚æ•°å‡åŒ€åˆ†å‰²ä¸ºæŒ‡å®šæ•°é‡çš„chunks
- `extract_chunk_data()`: æ ¹æ®chunkä¿¡æ¯æå–å¯¹åº”æ•°æ®ç‰‡æ®µ
- `save_model_chunks()`: å°†æ¨¡å‹åˆ†å—å¹¶ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
- `load_chunks_by_round()`: åŠ è½½æŒ‡å®šè½®æ¬¡çš„æ‰€æœ‰chunks
- `reconstruct_model_from_chunks()`: ä»chunksé‡æ„å®Œæ•´æ¨¡å‹

### 2. SQLiteæ•°æ®åº“å­˜å‚¨ç³»ç»Ÿ

**æ•°æ®åº“ç»“æ„**ï¼š
- **è·¯å¾„æ ¼å¼**: `/tmp/client_X/client_X_chunks.db`
- **chunk_metadataè¡¨**: å­˜å‚¨è½®æ¬¡ã€chunk IDã€hashã€å‚æ•°ä½ç½®ä¿¡æ¯ã€å¤§å°
- **chunk_dataè¡¨**: å­˜å‚¨hashå’Œå®é™…chunkæ•°æ®(BLOB)
- **ç´¢å¼•ä¼˜åŒ–**: `idx_chunk_metadata_round`, `idx_chunk_metadata_hash`

**å­˜å‚¨ç‰¹æ€§**ï¼š
- **å­˜å‚¨æ ¼å¼**: `(client_id, round_num, chunk_id) -> chunk_data`
- **Hashå»é‡**: ä½¿ç”¨SHA256å“ˆå¸Œå€¼ï¼Œç›¸åŒå†…å®¹chunksåªå­˜å‚¨ä¸€æ¬¡
- **UNIQUEçº¦æŸ**: ä¿è¯æ•°æ®ä¸€è‡´æ€§

### 3. è”é‚¦å­¦ä¹ å®¢æˆ·ç«¯é›†æˆ (`federatedscope/core/workers/client.py:768`)

**é›†æˆæ–¹å¼**ï¼š
- æ›¿æ¢äº†åŸæœ‰çš„`_save_local_model_after_training()`æ–¹æ³•
- ä»ç›´æ¥ä¿å­˜`.pth`æ–‡ä»¶æ”¹ä¸ºchunkå­˜å‚¨
- æ”¯æŒè‡ªåŠ¨æ£€æµ‹æ¨¡å‹ä½ç½®ï¼ˆ`trainer.ctx.model`æˆ–`trainer.model`ï¼‰

**é…ç½®å‚æ•°**ï¼š
- `cfg.chunk_num`: chunkæ•°é‡ (é»˜è®¤: 10)
- `cfg.chunk_keep_rounds`: ä¿ç•™è½®æ¬¡æ•°é‡
- è‡ªåŠ¨åˆå§‹åŒ–ChunkManagerå®ä¾‹

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•å¥—ä»¶

**æµ‹è¯•æ–‡ä»¶**ï¼š
- `test_chunk_storage_system.py`: åŸºç¡€åŠŸèƒ½æµ‹è¯•
- `test_chunk_recovery.py`: chunkæ¢å¤åŠŸèƒ½æµ‹è¯•
- `test_chunk_recovery_analysis.py`: BatchNormé—®é¢˜åˆ†æ
- `final_chunk_recovery_demo.py`: å®Œæ•´åŠŸèƒ½æ¼”ç¤º

**æµ‹è¯•è¦†ç›–**ï¼š
- âœ… æ¨¡å‹åˆ†å‰²ç®—æ³• (2-12ä¸ªchunks)
- âœ… Chunkæ•°æ®æå–å’Œå­˜å‚¨
- âœ… æ¨¡å‹å‚æ•°å®Œç¾æ¢å¤ (è¯¯å·®<1e-8)
- âœ… å¤šç§æ¨¡å‹æ¶æ„ (CNN, ç®€å•ç½‘ç»œ, BatchNorm)
- âœ… å­˜å‚¨æŒä¹…æ€§å’Œæ•°æ®å®Œæ•´æ€§

### 2. å¤šè¿›ç¨‹åˆ†å¸ƒå¼FLæµ‹è¯•

**æµ‹è¯•è„šæœ¬**: `multi_process_fl_test_v2.sh`

**æµ‹è¯•ç¯å¢ƒ**ï¼š
- 1ä¸ªæœåŠ¡å™¨ + 3ä¸ªå®¢æˆ·ç«¯
- ä½¿ç”¨toyæ•°æ®é›†å’Œçº¿æ€§å›å½’æ¨¡å‹
- 5è½®è®­ç»ƒï¼Œæ¯è½®2ä¸ªæœ¬åœ°æ›´æ–°æ­¥éª¤
- SGDä¼˜åŒ–å™¨ (lr=0.01)

**æµ‹è¯•ç»“æœ**ï¼š
- âœ… è®­ç»ƒæ­£å¸¸å®Œæˆï¼ŒæŸå¤±æ”¶æ•› (6496â†’4586)
- âœ… Starç½‘ç»œæ‹“æ‰‘æ„å»ºæˆåŠŸ
- âœ… æ¯ä¸ªå®¢æˆ·ç«¯ç”Ÿæˆ40KBæ•°æ®åº“æ–‡ä»¶
- âœ… æˆåŠŸä¿å­˜50ä¸ªå…ƒæ•°æ®æ¡ç›®å’Œ7ä¸ªå”¯ä¸€chunks

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å­˜å‚¨æ•ˆç‡
- **åŸå§‹æ¨¡å‹**: çº¦1647KB (42ä¸‡å‚æ•°)
- **æ•°æ®åº“å­˜å‚¨**: çº¦1610KB
- **å‹ç¼©ç‡**: ~1.0x (åŸºæœ¬æ— æŸ)
- **å»é‡æ•ˆæœ**: ç›¸åŒå†…å®¹chunksè‡ªåŠ¨å»é‡

### æ¢å¤å‡†ç¡®æ€§
- **å¯è®­ç»ƒå‚æ•°**: å®Œç¾æ¢å¤ (è¯¯å·®<1e-8)
- **æ¨¡å‹åŠŸèƒ½**: å‰å‘ä¼ æ’­è¾“å‡ºå®Œå…¨ä¸€è‡´
- **BatchNormå¤„ç†**: æ­£ç¡®åŒºåˆ†å¯è®­ç»ƒå‚æ•°å’Œbuffer

### å®é™…FLæ€§èƒ½
- **æ¨¡å‹**: çº¿æ€§å›å½’ (fc.weight [1,10], fc.bias [1])
- **æ€»å‚æ•°**: 11ä¸ª (10ä¸ªæƒé‡ + 1ä¸ªåç½®)
- **åˆ†å—ç­–ç•¥**: 10ä¸ªchunksï¼Œå¤§éƒ¨åˆ†ä¸ºç©ºï¼Œæœ€åä¸€ä¸ªåŒ…å«æ‰€æœ‰å‚æ•°
- **æ¢å¤æ—¶é—´**: <100ms

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### BatchNormå±‚å¤„ç†
å‘ç°å¹¶æ­£ç¡®å¤„ç†äº†BatchNormå±‚çš„bufferé—®é¢˜ï¼š
- `running_mean`, `running_var`, `num_batches_tracked`æ˜¯ä¸å¯è®­ç»ƒçš„buffer
- è¿™äº›bufferåœ¨å‰å‘ä¼ æ’­æ—¶ä¼šæ›´æ–°ï¼Œå¯¼è‡´æ•°å€¼å·®å¼‚
- å¯¹è”é‚¦å­¦ä¹ æ— å½±å“ï¼Œå› ä¸ºåªæœ‰å¯è®­ç»ƒå‚æ•°å‚ä¸èšåˆ

### å‚æ•°å‘½åå…¼å®¹æ€§
- FLè®­ç»ƒä¸­å®é™…ä½¿ç”¨: `fc.weight`, `fc.bias`
- æµ‹è¯•ç¯å¢ƒä¸­ä½¿ç”¨: `linear.weight`, `linear.bias`
- ChunkManagerè‡ªåŠ¨å¤„ç†ä¸åŒå‘½åçº¦å®š

### é”™è¯¯å¤„ç†å’Œæ—¥å¿—
- å®Œæ•´çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- è¯¦ç»†çš„debugæ—¥å¿—è®°å½•
- è‡ªåŠ¨æ£€æµ‹æ¨¡å‹å­˜åœ¨ä½ç½®
- ä¼˜é›…çš„é”™è¯¯é™çº§å¤„ç†

## ğŸ¯ éªŒè¯ç»“æœ

### åŠŸèƒ½éªŒè¯
| æµ‹è¯•é¡¹ç›® | çŠ¶æ€ | è¯¦ç»†ç»“æœ |
|---------|------|----------|
| æ¨¡å‹åˆ†å—ç®—æ³• | âœ… é€šè¿‡ | æ”¯æŒ2-12ä¸ªchunksï¼Œç®—æ³•æ­£ç¡® |
| SQLiteå­˜å‚¨ | âœ… é€šè¿‡ | æ•°æ®å®Œæ•´æ€§100% |
| å‚æ•°æ¢å¤ | âœ… é€šè¿‡ | è¯¯å·®<1e-8ï¼ŒåŠŸèƒ½å®Œå…¨æ­£å¸¸ |
| å¤šè¿›ç¨‹FL | âœ… é€šè¿‡ | 3å®¢æˆ·ç«¯5è½®è®­ç»ƒæˆåŠŸ |
| å­˜å‚¨å»é‡ | âœ… é€šè¿‡ | Hashå»é‡æœ‰æ•ˆèŠ‚çœç©ºé—´ |

### é›†æˆéªŒè¯
- âœ… æ— ç¼æ›¿æ¢åŸæœ‰æ¨¡å‹ä¿å­˜æœºåˆ¶
- âœ… ä¿æŒFLè®­ç»ƒæµç¨‹å®Œå…¨ä¸å˜
- âœ… æ”¯æŒç°æœ‰é…ç½®å‚æ•°ä½“ç³»
- âœ… å‘åå…¼å®¹å’Œé”™è¯¯å®¹é”™

## ğŸ“¦ äº¤ä»˜ç‰©

### æ ¸å¿ƒä»£ç 
1. `federatedscope/core/chunk_manager.py` (474è¡Œ) - ChunkManagerç±»å®ç°
2. `federatedscope/core/workers/client.py` (ä¿®æ”¹) - FLå®¢æˆ·ç«¯é›†æˆ

### æµ‹è¯•ä»£ç 
3. `test_chunk_storage_system.py` - åŸºç¡€åŠŸèƒ½æµ‹è¯•
4. `test_chunk_recovery.py` - æ¢å¤åŠŸèƒ½éªŒè¯
5. `test_chunk_recovery_analysis.py` - BatchNormåˆ†æ
6. `final_chunk_recovery_demo.py` - å®Œæ•´æ¼”ç¤º
7. `quick_chunk_test.py` - å¿«é€ŸéªŒè¯
8. `simple_fl_chunk_test.py` - ç®€å•FLæµ‹è¯•

### æµ‹è¯•è„šæœ¬
9. `multi_process_fl_test_v2.sh` - å¤šè¿›ç¨‹FLæµ‹è¯•è„šæœ¬

### ç”Ÿæˆæ–‡ä»¶
10. `tmp/client_1/client_1_chunks.db` - å®¢æˆ·ç«¯1æ•°æ®åº“
11. `tmp/client_2/client_2_chunks.db` - å®¢æˆ·ç«¯2æ•°æ®åº“  
12. `tmp/client_3/client_3_chunks.db` - å®¢æˆ·ç«¯3æ•°æ®åº“

## ğŸš€ Gitæäº¤è®°å½•

**æäº¤å“ˆå¸Œ**: `57e8f93`
**æäº¤ä¿¡æ¯**: "Implement chunked model storage system to replace traditional model saving"
**ä¿®æ”¹ç»Ÿè®¡**: 12ä¸ªæ–‡ä»¶ï¼Œæ–°å¢2257è¡Œï¼Œä¿®æ”¹31è¡Œ
**è¿œç¨‹ä»“åº“**: https://github.com/lnc007lnc/FederatedScope-Enhanced.git

## ğŸ“ æ€»ç»“

æˆåŠŸå®ç°äº†å®Œæ•´çš„æ¨¡å‹åˆ†å—å­˜å‚¨ç³»ç»Ÿï¼Œæ‰€æœ‰ç›®æ ‡å‡å·²è¾¾æˆï¼š

1. âœ… **ç®—æ³•å®ç°**: åŸºäºç”¨æˆ·æä¾›çš„æ‰å¹³ç´¢å¼•ç®—æ³•
2. âœ… **å­˜å‚¨æ ¼å¼**: `(client_id, round_num, chunk_id) -> chunk_data`
3. âœ… **æ•°æ®åº“é›†æˆ**: SQLiteæœ¬åœ°å­˜å‚¨ï¼Œæ”¯æŒå»é‡å’Œç´¢å¼•
4. âœ… **FLé›†æˆ**: æ— ç¼æ›¿æ¢åŸæœ‰æ¨¡å‹ä¿å­˜æœºåˆ¶
5. âœ… **å®Œç¾æ¢å¤**: æ‰€æœ‰å¯è®­ç»ƒå‚æ•°ç²¾ç¡®æ¢å¤
6. âœ… **å®é™…éªŒè¯**: å¤šè¿›ç¨‹åˆ†å¸ƒå¼FLç¯å¢ƒæµ‹è¯•é€šè¿‡

è¯¥ç³»ç»Ÿç°å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œä¸ºFederatedScopeæä¾›äº†é«˜æ•ˆã€å¯é çš„æ¨¡å‹åˆ†å—å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚

---

**å®æ–½æ—¶é—´**: 2025å¹´8æœˆ20-21æ—¥  
**ç‰ˆæœ¬**: v1.0.0  
**çŠ¶æ€**: âœ… å®Œæˆå¹¶éƒ¨ç½²