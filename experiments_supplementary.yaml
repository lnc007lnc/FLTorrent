# ============================================================================
# FLTorrent Supplementary Experiments Configuration (Reviewer-Ready Version)
# ============================================================================
# Usage: python run_ray_hpc.py --batch experiments_supplementary.yaml
#        python run_ray_hpc.py --batch experiments_supplementary.yaml --dry-run
# ============================================================================
# Changes after SIGCOMM reviewer feedback:
# - Exp1: slow BW = 100 Mbps, fast BW = 0 (unlimited), timeout = 30s
# - Exp2: FAIR comparison - both comp/wait get same churn (skip mode)
#         timeout = 60s for both groups
# - Exp3: 3 runs each for statistical significance
# ============================================================================

global:
  # Output directories
  code_snapshot_dir: "./experiments_snapshots"
  output_base_dir: "./experiments_output_supplementary"

  # Default SLURM settings (gpu2)
  partition: "gpu2"
  nodes: 1
  gpus_per_node: 4
  cpus_per_task: 64
  mem: "480G"
  time_limit: "48:00:00"

  # Common FL settings (inherited by all experiments)
  CLIENT_NUM: 50
  TOTAL_ROUNDS: 100
  CHUNK_NUM: 16
  CHUNK_TMP_DIR: "/tmp/fl_chunks_celeba"
  DATA_ROOT: "./data/"

  # Dataset settings (CelebA)
  DATASET: "celeba"
  DATA_SPLITTER: "lda"
  DATA_SPLIT_ALPHA: 0.3
  DATA_SPLITS: [0.8, 0.1, 0.1]
  DATA_SHARE_TEST_DATASET: true

  # Model settings (ResNet18 for binary classification)
  MODEL_TYPE: "resnet18"
  MODEL_OUT_CHANNELS: 1
  CRITERION_TYPE: "BCEWithLogitsLoss"
  TRAINER_TYPE: "cvtrainer"

  # Training settings
  BATCH_SIZE: 16
  LEARNING_RATE: 0.0001
  OPTIMIZER: "Adam"
  WEIGHT_DECAY: 0.0005
  GRAD_CLIP: 5.0
  LOCAL_UPDATE_STEPS: 1

  # Learning rate scheduler
  LR_SCHEDULER_TYPE: "SequentialLR"
  LR_SCHEDULER_PHASE1_START_FACTOR: 0.01
  LR_SCHEDULER_PHASE1_TOTAL_ITERS: 10
  LR_SCHEDULER_PHASE2_T_MAX: 90
  LR_SCHEDULER_PHASE2_ETA_MIN: 0.00000001
  LR_SCHEDULER_MILESTONES: [11]

  # Evaluation
  EVAL_FREQ: 1
  EVAL_METRICS: ["acc", "correct", "f1"]

  # Topology settings
  TOPOLOGY_TYPE: "mesh"
  TOPOLOGY_CONNECTIONS: 4

  # BitTorrent base settings
  BITTORRENT_ENABLE: true
  BT_RARITY_WEIGHT: 0.01
  BT_CHUNK_SELECTION: "rarest_first"
  BT_SAVE_STATISTICS: true
  GOSSIP_ENABLE: false

experiments:
  # ============================================================================
  # EXPERIMENT 1: Bandwidth Heterogeneity + Fairness
  # ============================================================================
  # Goal: Demonstrate compensation resolves partial participation bias
  # Setup: 50% fast (unlimited), 50% slow (100 Mbps), timeout = 30s
  # ============================================================================

  # --- Compensation ON (3 runs) ---
  - name: "exp1_bw_comp_on_run1"
    description: "BW Heterogeneity + Compensation ON (run 1)"
    config:
      RANDOM_SEED: 1
      BITTORRENT_TIMEOUT: 30.0
      BT_ENABLE_COMPENSATION: true
      BT_BANDWIDTH_HETEROGENEITY: true
      BT_SLOW_CLIENT_RATIO: 0.5
      BT_FAST_BANDWIDTH_MBPS: 0.0
      BT_SLOW_BANDWIDTH_MBPS: 100.0

  - name: "exp1_bw_comp_on_run2"
    description: "BW Heterogeneity + Compensation ON (run 2)"
    config:
      RANDOM_SEED: 2
      BITTORRENT_TIMEOUT: 30.0
      BT_ENABLE_COMPENSATION: true
      BT_BANDWIDTH_HETEROGENEITY: true
      BT_SLOW_CLIENT_RATIO: 0.5
      BT_FAST_BANDWIDTH_MBPS: 0.0
      BT_SLOW_BANDWIDTH_MBPS: 100.0

  - name: "exp1_bw_comp_on_run3"
    description: "BW Heterogeneity + Compensation ON (run 3)"
    config:
      RANDOM_SEED: 3
      BITTORRENT_TIMEOUT: 30.0
      BT_ENABLE_COMPENSATION: true
      BT_BANDWIDTH_HETEROGENEITY: true
      BT_SLOW_CLIENT_RATIO: 0.5
      BT_FAST_BANDWIDTH_MBPS: 0.0
      BT_SLOW_BANDWIDTH_MBPS: 100.0

  # --- Compensation OFF (3 runs) ---
  - name: "exp1_bw_comp_off_run1"
    description: "BW Heterogeneity + Compensation OFF (run 1)"
    config:
      RANDOM_SEED: 1
      BITTORRENT_TIMEOUT: 30.0
      BT_ENABLE_COMPENSATION: false
      BT_BANDWIDTH_HETEROGENEITY: true
      BT_SLOW_CLIENT_RATIO: 0.5
      BT_FAST_BANDWIDTH_MBPS: 0.0
      BT_SLOW_BANDWIDTH_MBPS: 100.0

  - name: "exp1_bw_comp_off_run2"
    description: "BW Heterogeneity + Compensation OFF (run 2)"
    config:
      RANDOM_SEED: 2
      BITTORRENT_TIMEOUT: 30.0
      BT_ENABLE_COMPENSATION: false
      BT_BANDWIDTH_HETEROGENEITY: true
      BT_SLOW_CLIENT_RATIO: 0.5
      BT_FAST_BANDWIDTH_MBPS: 0.0
      BT_SLOW_BANDWIDTH_MBPS: 100.0

  - name: "exp1_bw_comp_off_run3"
    description: "BW Heterogeneity + Compensation OFF (run 3)"
    config:
      RANDOM_SEED: 3
      BITTORRENT_TIMEOUT: 30.0
      BT_ENABLE_COMPENSATION: false
      BT_BANDWIDTH_HETEROGENEITY: true
      BT_SLOW_CLIENT_RATIO: 0.5
      BT_FAST_BANDWIDTH_MBPS: 0.0
      BT_SLOW_BANDWIDTH_MBPS: 100.0

  # ============================================================================
  # EXPERIMENT 2: Churn Injection (FAIR Comparison)
  # ============================================================================
  # Goal: Show compensation robustness under node failures
  # KEY: Both comp & wait experience SAME churn events (skip mode)
  # Difference: comp has compensation, wait does not
  # timeout = 60s for both (not 3600s for wait)
  # ============================================================================

  # --- Churn 0% + Compensation (baseline) -> GPU3 for redundancy ---
  - name: "exp2_churn_p0_comp_run1"
    description: "Churn 0% + Compensation (run 1)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      RANDOM_SEED: 1
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: true
      BT_CHURN_INJECTION: false

  - name: "exp2_churn_p0_comp_run2"
    description: "Churn 0% + Compensation (run 2)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      RANDOM_SEED: 2
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: true
      BT_CHURN_INJECTION: false

  - name: "exp2_churn_p0_comp_run3"
    description: "Churn 0% + Compensation (run 3)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      RANDOM_SEED: 3
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: true
      BT_CHURN_INJECTION: false

  # --- Churn 10% + Compensation ---
  - name: "exp2_churn_p10_comp_run1"
    description: "Churn 10% + Compensation (run 1)"
    config:
      RANDOM_SEED: 1
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: true
      BT_CHURN_INJECTION: true
      BT_CHURN_RATE: 0.1
      BT_CHURN_MODE: "skip"

  - name: "exp2_churn_p10_comp_run2"
    description: "Churn 10% + Compensation (run 2)"
    config:
      RANDOM_SEED: 2
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: true
      BT_CHURN_INJECTION: true
      BT_CHURN_RATE: 0.1
      BT_CHURN_MODE: "skip"

  - name: "exp2_churn_p10_comp_run3"
    description: "Churn 10% + Compensation (run 3)"
    config:
      RANDOM_SEED: 3
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: true
      BT_CHURN_INJECTION: true
      BT_CHURN_RATE: 0.1
      BT_CHURN_MODE: "skip"

  # --- Churn 20% + Compensation ---
  - name: "exp2_churn_p20_comp_run1"
    description: "Churn 20% + Compensation (run 1)"
    config:
      RANDOM_SEED: 1
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: true
      BT_CHURN_INJECTION: true
      BT_CHURN_RATE: 0.2
      BT_CHURN_MODE: "skip"

  - name: "exp2_churn_p20_comp_run2"
    description: "Churn 20% + Compensation (run 2)"
    config:
      RANDOM_SEED: 2
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: true
      BT_CHURN_INJECTION: true
      BT_CHURN_RATE: 0.2
      BT_CHURN_MODE: "skip"

  - name: "exp2_churn_p20_comp_run3"
    description: "Churn 20% + Compensation (run 3)"
    config:
      RANDOM_SEED: 3
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: true
      BT_CHURN_INJECTION: true
      BT_CHURN_RATE: 0.2
      BT_CHURN_MODE: "skip"

  # --- Churn 0% NO Compensation (baseline) ---
  - name: "exp2_churn_p0_wait_run1"
    description: "Churn 0% NO Compensation (run 1)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      RANDOM_SEED: 1
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: false
      BT_CHURN_INJECTION: false

  - name: "exp2_churn_p0_wait_run2"
    description: "Churn 0% NO Compensation (run 2)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      RANDOM_SEED: 2
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: false
      BT_CHURN_INJECTION: false

  - name: "exp2_churn_p0_wait_run3"
    description: "Churn 0% NO Compensation (run 3)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      RANDOM_SEED: 3
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: false
      BT_CHURN_INJECTION: false

  # --- Churn 10% NO Compensation (FAIR: same churn as comp) ---
  - name: "exp2_churn_p10_wait_run1"
    description: "Churn 10% NO Compensation (run 1)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      RANDOM_SEED: 1
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: false
      BT_CHURN_INJECTION: true
      BT_CHURN_RATE: 0.1
      BT_CHURN_MODE: "skip"

  - name: "exp2_churn_p10_wait_run2"
    description: "Churn 10% NO Compensation (run 2)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      RANDOM_SEED: 2
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: false
      BT_CHURN_INJECTION: true
      BT_CHURN_RATE: 0.1
      BT_CHURN_MODE: "skip"

  - name: "exp2_churn_p10_wait_run3"
    description: "Churn 10% NO Compensation (run 3)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      RANDOM_SEED: 3
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: false
      BT_CHURN_INJECTION: true
      BT_CHURN_RATE: 0.1
      BT_CHURN_MODE: "skip"

  # --- Churn 20% NO Compensation (FAIR: same churn as comp) ---
  - name: "exp2_churn_p20_wait_run1"
    description: "Churn 20% NO Compensation (run 1)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      RANDOM_SEED: 1
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: false
      BT_CHURN_INJECTION: true
      BT_CHURN_RATE: 0.2
      BT_CHURN_MODE: "skip"

  - name: "exp2_churn_p20_wait_run2"
    description: "Churn 20% NO Compensation (run 2)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      RANDOM_SEED: 2
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: false
      BT_CHURN_INJECTION: true
      BT_CHURN_RATE: 0.2
      BT_CHURN_MODE: "skip"

  - name: "exp2_churn_p20_wait_run3"
    description: "Churn 20% NO Compensation (run 3)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      RANDOM_SEED: 3
      BITTORRENT_TIMEOUT: 60.0
      BT_ENABLE_COMPENSATION: false
      BT_CHURN_INJECTION: true
      BT_CHURN_RATE: 0.2
      BT_CHURN_MODE: "skip"

  # ============================================================================
  # EXPERIMENT 3: Protocol-only Scaling (3 runs each)
  # ============================================================================
  # Goal: Demonstrate protocol scales to 100/200 clients
  # Settings: Synthetic 1MB chunks, 10 rounds, toy dataset
  # ============================================================================

  # --- N=50 (3 runs) ---
  - name: "exp3_scaling_n50_run1"
    description: "Protocol-only N=50 (run 1)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      CLIENT_NUM: 50
      TOTAL_ROUNDS: 10
      RANDOM_SEED: 1
      DATASET: "toy"
      MODEL_TYPE: "lr"
      BITTORRENT_TIMEOUT: 30.0
      BT_ENABLE_COMPENSATION: true
      BT_PROTOCOL_ONLY: true
      BT_SYNTHETIC_CHUNK_SIZE: 1048576
      BT_SYNTHETIC_NUM_CHUNKS: 16

  - name: "exp3_scaling_n50_run2"
    description: "Protocol-only N=50 (run 2)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      CLIENT_NUM: 50
      TOTAL_ROUNDS: 10
      RANDOM_SEED: 2
      DATASET: "toy"
      MODEL_TYPE: "lr"
      BITTORRENT_TIMEOUT: 30.0
      BT_ENABLE_COMPENSATION: true
      BT_PROTOCOL_ONLY: true
      BT_SYNTHETIC_CHUNK_SIZE: 1048576
      BT_SYNTHETIC_NUM_CHUNKS: 16

  - name: "exp3_scaling_n50_run3"
    description: "Protocol-only N=50 (run 3)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      CLIENT_NUM: 50
      TOTAL_ROUNDS: 10
      RANDOM_SEED: 3
      DATASET: "toy"
      MODEL_TYPE: "lr"
      BITTORRENT_TIMEOUT: 30.0
      BT_ENABLE_COMPENSATION: true
      BT_PROTOCOL_ONLY: true
      BT_SYNTHETIC_CHUNK_SIZE: 1048576
      BT_SYNTHETIC_NUM_CHUNKS: 16

  # --- N=100 (3 runs) ---
  - name: "exp3_scaling_n100_run1"
    description: "Protocol-only N=100 (run 1)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      CLIENT_NUM: 100
      TOTAL_ROUNDS: 10
      RANDOM_SEED: 1
      DATASET: "toy"
      MODEL_TYPE: "lr"
      BITTORRENT_TIMEOUT: 30.0
      BT_ENABLE_COMPENSATION: true
      BT_PROTOCOL_ONLY: true
      BT_SYNTHETIC_CHUNK_SIZE: 1048576
      BT_SYNTHETIC_NUM_CHUNKS: 16

  - name: "exp3_scaling_n100_run2"
    description: "Protocol-only N=100 (run 2)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      CLIENT_NUM: 100
      TOTAL_ROUNDS: 10
      RANDOM_SEED: 2
      DATASET: "toy"
      MODEL_TYPE: "lr"
      BITTORRENT_TIMEOUT: 30.0
      BT_ENABLE_COMPENSATION: true
      BT_PROTOCOL_ONLY: true
      BT_SYNTHETIC_CHUNK_SIZE: 1048576
      BT_SYNTHETIC_NUM_CHUNKS: 16

  - name: "exp3_scaling_n100_run3"
    description: "Protocol-only N=100 (run 3)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      CLIENT_NUM: 100
      TOTAL_ROUNDS: 10
      RANDOM_SEED: 3
      DATASET: "toy"
      MODEL_TYPE: "lr"
      BITTORRENT_TIMEOUT: 30.0
      BT_ENABLE_COMPENSATION: true
      BT_PROTOCOL_ONLY: true
      BT_SYNTHETIC_CHUNK_SIZE: 1048576
      BT_SYNTHETIC_NUM_CHUNKS: 16

  # --- N=200 (3 runs) ---
  - name: "exp3_scaling_n200_run1"
    description: "Protocol-only N=200 (run 1)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      CLIENT_NUM: 200
      TOTAL_ROUNDS: 10
      RANDOM_SEED: 1
      DATASET: "toy"
      MODEL_TYPE: "lr"
      BITTORRENT_TIMEOUT: 30.0
      BT_ENABLE_COMPENSATION: true
      BT_PROTOCOL_ONLY: true
      BT_SYNTHETIC_CHUNK_SIZE: 1048576
      BT_SYNTHETIC_NUM_CHUNKS: 16

  - name: "exp3_scaling_n200_run2"
    description: "Protocol-only N=200 (run 2)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      CLIENT_NUM: 200
      TOTAL_ROUNDS: 10
      RANDOM_SEED: 2
      DATASET: "toy"
      MODEL_TYPE: "lr"
      BITTORRENT_TIMEOUT: 30.0
      BT_ENABLE_COMPENSATION: true
      BT_PROTOCOL_ONLY: true
      BT_SYNTHETIC_CHUNK_SIZE: 1048576
      BT_SYNTHETIC_NUM_CHUNKS: 16

  - name: "exp3_scaling_n200_run3"
    description: "Protocol-only N=200 (run 3)"
    partition: "gpu3"
    gpus_per_node: 2
    cpus_per_task: 128
    mem: "1400G"
    config:
      CLIENT_NUM: 200
      TOTAL_ROUNDS: 10
      RANDOM_SEED: 3
      DATASET: "toy"
      MODEL_TYPE: "lr"
      BITTORRENT_TIMEOUT: 30.0
      BT_ENABLE_COMPENSATION: true
      BT_PROTOCOL_ONLY: true
      BT_SYNTHETIC_CHUNK_SIZE: 1048576
      BT_SYNTHETIC_NUM_CHUNKS: 16
